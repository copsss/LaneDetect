# 车道偏离预警系统测试说明

## 概述

本目录包含了车道偏离预警系统的完整测试文档和测试脚本，用于验证系统在飞腾派开发板上的功能和性能。

## 文件说明

### 测试文档
- `车道偏离预警系统测试报告.md` - 完整的测试报告，包含所有实训要求的内容

### 测试脚本
- `performance_test.sh` - 性能测试脚本，测试不同配置下的系统性能
- `functional_test.sh` - 功能测试脚本，测试系统的各项功能
- `module_performance_test.sh` - **新增**：模块性能测试脚本，专门测试各个模块的执行时间

### 源代码文件
- `main.cpp` - 主程序文件（已修改为输出视频和性能统计）
- `LaneDetector.cpp` - 车道检测算法实现（已添加性能监控）
- `LaneDetector.h` - 车道检测类头文件（已添加性能统计接口）
- `Makefile` - 编译配置文件

## 使用方法

### 1. 编译程序

在飞腾派开发板上执行：

```bash
# 清理之前的编译文件
make clean

# 编译程序
make all
```

### 2. 运行功能测试

```bash
# 给测试脚本添加执行权限
chmod +x functional_test.sh

# 运行功能测试
./functional_test.sh
```

功能测试将：
- 测试正常车道线检测
- 测试弯道检测
- 测试复杂场景检测
- 验证边缘检测功能
- 验证车道线检测功能
- 进行系统稳定性测试

### 3. 运行性能测试

```bash
# 给测试脚本添加执行权限
chmod +x performance_test.sh

# 运行性能测试
./performance_test.sh
```

性能测试将：
- 测试单核处理性能
- 测试单核+NEON优化性能
- 测试多核处理性能
- 测试多核+NEON优化性能
- **新增**：记录整机执行时间和各模块执行时间

### 4. 运行模块性能测试（推荐）

```bash
# 给测试脚本添加执行权限
chmod +x module_performance_test.sh

# 运行模块性能测试
./module_performance_test.sh
```

模块性能测试将：
- **详细测试各模块执行时间**：图像去噪、边缘检测、掩码处理、Hough变换、线分离、回归拟合、转向预测、结果绘制
- **识别性能瓶颈**：自动分析哪个模块占用时间最多
- **多次测试取平均值**：每个配置运行5次，确保数据准确性
- **生成详细分析报告**：包含优化建议和性能对比

### 5. 查看测试结果

测试完成后，结果文件将保存在以下目录：
- `functional_test_results/` - 功能测试结果
- `test_results/` - 性能测试结果
- `module_test_results/` - **新增**：模块性能测试结果

## 测试环境要求

### 硬件要求
- 飞腾派教育开发板
- 至少4GB内存
- 足够的存储空间（建议>10GB）

### 软件要求
- Ubuntu 20.04 LTS或更高版本
- OpenCV 4.x库
- aarch64-linux-gnu-gcc/g++编译器
- bc计算器（用于性能计算）

### 安装依赖

```bash
# 安装必要的工具
sudo apt-get update
sudo apt-get install build-essential bc

# 安装OpenCV（如果尚未安装）
sudo apt-get install libopencv-dev
```

## 测试用例说明

### 功能测试用例

| 测试用例 | 描述 | 预期结果 |
|---------|------|---------|
| TC001 | 正常车道线检测 | 正确识别左右车道线 |
| TC002 | 弯道检测 | 正确识别弯道方向 |
| TC003 | 复杂场景检测 | 对复杂场景具有鲁棒性 |
| TC004 | 边缘检测功能 | 生成有效的边缘检测视频 |
| TC005 | 车道线检测功能 | 生成有效的车道线检测视频 |
| TC006 | 系统稳定性测试 | 连续运行5次无异常 |

### 性能测试配置

| 配置名称 | CPU核心数 | NEON优化 | 预期性能提升 |
|---------|----------|---------|-------------|
| 单核 | 1 | 否 | 基准 |
| 单核+NEON | 1 | 是 | +45% |
| 多核 | 4 | 否 | +87% |
| 多核+NEON | 4 | 是 | +135% |

### 模块性能测试（新增）

| 测试模块 | 功能描述 | 性能指标 |
|---------|---------|---------|
| 图像去噪 | Gaussian滤波去噪 | 执行时间(ms)、占比(%) |
| 边缘检测 | Sobel算子边缘检测 | 执行时间(ms)、占比(%) |
| 掩码处理 | ROI区域提取 | 执行时间(ms)、占比(%) |
| Hough变换 | 直线检测 | 执行时间(ms)、占比(%) |
| 线分离 | 左右车道线分离 | 执行时间(ms)、占比(%) |
| 回归拟合 | 车道线拟合 | 执行时间(ms)、占比(%) |
| 转向预测 | 转向判断 | 执行时间(ms)、占比(%) |
| 结果绘制 | 可视化输出 | 执行时间(ms)、占比(%) |

## 输出文件说明

### 程序输出文件
- `output_lane_detection_color.avi` - 彩色车道线检测结果视频
- `output_edge_detection_bw.avi` - 黑白边缘检测结果视频

### 功能测试结果文件
- `functional_test_results/` - 功能测试结果目录
  - `TC001_正常车道线检测_color.avi` - 测试用例1的彩色输出
  - `TC001_正常车道线检测_bw.avi` - 测试用例1的黑白输出
  - `functional_test_report.txt` - 功能测试报告

### 性能测试结果文件
- `test_results/` - 性能测试结果目录
  - `detailed_performance_results.csv` - **更新**：详细性能数据（包含模块时间）
  - `module_time_comparison.txt` - **新增**：模块时间对比
  - `*_output.log` - 各配置详细日志

### 模块性能测试结果文件（新增）
- `module_test_results/` - 模块性能测试结果目录
  - `module_performance_summary.csv` - 模块性能汇总数据
  - `module_analysis_report.txt` - 详细模块分析报告
  - `*_raw_data.csv` - 原始测试数据
  - `*_test*.log` - 各次测试的详细日志

## 性能数据分析

### 整机执行时间测试
- **测试内容**：整个视频处理流程的总执行时间
- **测试方法**：记录程序开始到结束的总时间
- **输出指标**：总执行时间(ms)、平均每帧处理时间(ms)、实际处理帧率(FPS)

### 模块执行时间测试
- **测试内容**：各个算法模块的执行时间
- **测试方法**：在每个模块开始和结束时记录时间戳
- **输出指标**：各模块执行时间(ms)、占总时间百分比(%)

### 性能瓶颈分析
系统会自动分析并识别：
- **主要瓶颈模块**：占用时间最多的模块
- **优化建议**：针对不同瓶颈的具体优化方案
- **性能提升潜力**：各模块的优化空间

## 故障排除

### 常见问题

1. **编译失败**
   ```bash
   # 检查OpenCV是否正确安装
   pkg-config --modversion opencv4
   
   # 检查编译器
   aarch64-linux-gnu-gcc --version
   ```

2. **测试脚本权限问题**
   ```bash
   chmod +x *.sh
   ```

3. **视频文件不存在**
   ```bash
   # 检查视频文件是否存在
   ls -la *.mp4
   ```

4. **内存不足**
   ```bash
   # 检查可用内存
   free -h
   
   # 清理系统缓存
   sudo sync && sudo echo 3 > /proc/sys/vm/drop_caches
   ```

5. **性能测试数据异常**
   ```bash
   # 检查bc计算器是否安装
   which bc
   
   # 检查awk是否可用
   which awk
   ```

### 调试方法

1. **查看详细日志**
   ```bash
   # 运行程序并查看详细输出
   ./main 2>&1 | tee debug.log
   ```

2. **监控系统资源**
   ```bash
   # 监控CPU和内存使用
   top -p $(pgrep main)
   ```

3. **检查输出文件**
   ```bash
   # 检查生成的文件
   ls -la output_*.avi
   ```

4. **分析性能数据**
   ```bash
   # 查看模块性能数据
   cat module_test_results/module_performance_summary.csv
   
   # 查看详细分析报告
   cat module_test_results/module_analysis_report.txt
   ```

## 报告生成

测试完成后，您可以：

1. 查看自动生成的测试报告
2. 将测试结果填入`车道偏离预警系统测试报告.md`
3. 根据实际测试结果调整报告中的数据
4. **新增**：使用模块性能分析报告进行深度优化

## 注意事项

1. **测试时间**：完整的功能测试和性能测试可能需要30-60分钟
2. **存储空间**：确保有足够的存储空间保存测试结果
3. **系统负载**：测试期间系统负载较高，避免同时运行其他重负载程序
4. **温度监控**：长时间测试时注意开发板温度，必要时增加散热
5. **数据准确性**：模块性能测试会运行多次取平均值，确保数据可靠性

## 联系信息

如有问题或建议，请联系开发团队。 